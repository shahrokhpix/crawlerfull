<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>انتخابگر بصری - پنل مدیریت</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="styles.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Vazir', 'Tahoma', sans-serif;
            background-color: #f8f9fa;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 20px;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .iframe-container {
            flex: 1;
            position: relative;
        }
        
        #previewFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .selector-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .selector-item.active {
            border-color: #0d6efd;
            background: #e7f3ff;
        }
        
        .selector-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .selector-value {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            font-size: 12px;
            word-break: break-all;
        }
        
        .selector-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .highlight-overlay {
            position: absolute;
            background: rgba(13, 110, 253, 0.2);
            border: 2px solid #0d6efd;
            pointer-events: none;
            z-index: 1000;
        }
        
        .url-input {
            flex: 1;
        }
        
        .config-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .btn-sm {
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .selector-preview {
            max-height: 100px;
            overflow-y: auto;
            font-size: 11px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .element-info {
            font-size: 11px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1055;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="d-flex align-items-center mb-4">
                <h4 class="mb-0">انتخابگر بصری</h4>
                <button class="btn btn-outline-secondary btn-sm ms-auto" onclick="window.close()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Configuration Form -->
            <div class="config-form">
                <h6 class="mb-3">تنظیمات پیکربندی</h6>
                <div class="mb-3">
                    <label class="form-label">نام پیکربندی</label>
                    <input type="text" class="form-control" id="configName" placeholder="نام پیکربندی را وارد کنید">
                </div>
                <div class="mb-3">
                    <label class="form-label">توضیحات</label>
                    <textarea class="form-control" id="configDescription" rows="2" placeholder="توضیحات اختیاری"></textarea>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="saveConfiguration()">
                        <i class="fas fa-save me-2"></i>ذخیره پیکربندی
                    </button>
                    <button class="btn btn-outline-primary" onclick="testSelectors()">
                        <i class="fas fa-play me-2"></i>تست انتخابگرها
                    </button>
                </div>
            </div>
            
            <!-- Selectors List -->
            <div class="selectors-container">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="mb-0">انتخابگرهای تعریف شده</h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="addNewSelector()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="selectorsList">
                    <!-- Selectors will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Preview Container -->
        <div class="preview-container">
            <!-- Toolbar -->
            <div class="toolbar">
                <input type="url" class="form-control url-input" id="targetUrl" placeholder="آدرس صفحه وب را وارد کنید...">
                <button class="btn btn-primary" onclick="loadPage()">
                    <i class="fas fa-globe me-2"></i>بارگذاری
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshPage()">
                    <i class="fas fa-refresh"></i>
                </button>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="highlightMode" checked>
                    <label class="form-check-label" for="highlightMode">
                        حالت انتخاب
                    </label>
                </div>
            </div>
            
            <!-- Preview Frame -->
            <div class="iframe-container">
                <div class="loading-overlay d-none" id="loadingOverlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">در حال بارگذاری...</span>
                    </div>
                </div>
                <iframe id="previewFrame" src="about:blank"></iframe>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="selector-builder.js"></script>
    
    <script>
        // Global variables
        let selectors = {};
        let currentEditingSelector = null;
        let highlightOverlay = null;
        let configId = null; // For editing existing configs
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const targetUrl = urlParams.get('url');
            const editId = urlParams.get('edit');
            
            if (editId) {
                loadExistingConfig(editId);
            } else if (targetUrl) {
                document.getElementById('targetUrl').value = decodeURIComponent(targetUrl);
                loadPage();
            }
            
            // Add default selectors
            addDefaultSelectors();
        }
        
        function addDefaultSelectors() {
            const defaultSelectors = [
                { name: 'title', label: 'عنوان مقاله', selector: '' },
                { name: 'content', label: 'محتوای مقاله', selector: '' },
                { name: 'summary', label: 'خلاصه مقاله', selector: '' },
                { name: 'author', label: 'نویسنده', selector: '' },
                { name: 'publishDate', label: 'تاریخ انتشار', selector: '' },
                { name: 'category', label: 'دسته‌بندی', selector: '' },
                { name: 'tags', label: 'برچسب‌ها', selector: '' },
                { name: 'image', label: 'تصویر اصلی', selector: '' }
            ];
            
            defaultSelectors.forEach(item => {
                selectors[item.name] = {
                    label: item.label,
                    selector: item.selector,
                    element: null
                };
            });
            
            renderSelectors();
        }
        
        function renderSelectors() {
            const container = document.getElementById('selectorsList');
            container.innerHTML = '';
            
            Object.keys(selectors).forEach(key => {
                const selectorData = selectors[key];
                const selectorElement = createSelectorElement(key, selectorData);
                container.appendChild(selectorElement);
            });
        }
        
        function createSelectorElement(key, data) {
            const div = document.createElement('div');
            div.className = 'selector-item';
            div.dataset.selectorKey = key;
            
            div.innerHTML = `
                <div class="selector-label">${data.label}</div>
                <div class="selector-value" id="selector-${key}">${data.selector || 'انتخاب نشده'}</div>
                <div class="element-info" id="info-${key}"></div>
                <div class="selector-preview" id="preview-${key}" style="display: none;"></div>
                <div class="selector-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="startSelecting('${key}')">
                        <i class="fas fa-crosshairs me-1"></i>انتخاب
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="editSelector('${key}')">
                        <i class="fas fa-edit me-1"></i>ویرایش
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearSelector('${key}')">
                        <i class="fas fa-trash me-1"></i>پاک
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="testSelector('${key}')">
                        <i class="fas fa-play me-1"></i>تست
                    </button>
                </div>
            `;
            
            return div;
        }
        
        function loadPage() {
            const url = document.getElementById('targetUrl').value;
            if (!url) {
                showToast('لطفاً آدرس صفحه را وارد کنید', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Use proxy endpoint to load the page
            const proxyUrl = `/api/selector-builder/proxy?url=${encodeURIComponent(url)}`;
            const iframe = document.getElementById('previewFrame');
            
            iframe.onload = function() {
                showLoading(false);
                setupIframeInteraction();
            };
            
            iframe.onerror = function() {
                showLoading(false);
                showToast('خطا در بارگذاری صفحه', 'error');
            };
            
            iframe.src = proxyUrl;
        }
        
        function refreshPage() {
            loadPage();
        }
        
        function setupIframeInteraction() {
            const iframe = document.getElementById('previewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            if (!iframeDoc) {
                console.warn('Cannot access iframe content');
                return;
            }
            
            // Add click event listener to iframe content
            iframeDoc.addEventListener('click', function(e) {
                if (!document.getElementById('highlightMode').checked || !currentEditingSelector) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                
                const element = e.target;
                selectElement(element);
            });
            
            // Add mouseover event for highlighting
            iframeDoc.addEventListener('mouseover', function(e) {
                if (!document.getElementById('highlightMode').checked || !currentEditingSelector) {
                    return;
                }
                
                highlightElement(e.target);
            });
        }
        
        function startSelecting(selectorKey) {
            currentEditingSelector = selectorKey;
            
            // Highlight the active selector
            document.querySelectorAll('.selector-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectorElement = document.querySelector(`[data-selector-key="${selectorKey}"]`);
            if (selectorElement) {
                selectorElement.classList.add('active');
            }
            
            showToast(`حالت انتخاب برای "${selectors[selectorKey].label}" فعال شد`, 'info');
        }
        
        function selectElement(element) {
            if (!currentEditingSelector) return;
            
            const selector = generateSelector(element);
            selectors[currentEditingSelector].selector = selector;
            selectors[currentEditingSelector].element = element;
            
            // Update UI
            document.getElementById(`selector-${currentEditingSelector}`).textContent = selector;
            
            // Show element info
            const info = `تگ: ${element.tagName.toLowerCase()}, کلاس: ${element.className || 'ندارد'}, ID: ${element.id || 'ندارد'}`;
            document.getElementById(`info-${currentEditingSelector}`).textContent = info;
            
            // Show preview
            showElementPreview(currentEditingSelector, element);
            
            // Clear selection mode
            currentEditingSelector = null;
            document.querySelectorAll('.selector-item').forEach(item => {
                item.classList.remove('active');
            });
            
            removeHighlight();
            showToast('انتخابگر با موفقیت تنظیم شد', 'success');
        }
        
        function generateSelector(element) {
            // Generate a unique CSS selector for the element
            const path = [];
            let current = element;
            
            while (current && current.nodeType === Node.ELEMENT_NODE) {
                let selector = current.tagName.toLowerCase();
                
                if (current.id) {
                    selector += `#${current.id}`;
                    path.unshift(selector);
                    break;
                } else {
                    let sibling = current;
                    let nth = 1;
                    while (sibling = sibling.previousElementSibling) {
                        if (sibling.tagName.toLowerCase() === selector) nth++;
                    }
                    if (nth !== 1) selector += `:nth-of-type(${nth})`;
                }
                
                path.unshift(selector);
                current = current.parentElement;
            }
            
            return path.join(' > ');
        }
        
        function highlightElement(element) {
            const iframe = document.getElementById('previewFrame');
            const rect = element.getBoundingClientRect();
            const iframeRect = iframe.getBoundingClientRect();
            
            removeHighlight();
            
            highlightOverlay = document.createElement('div');
            highlightOverlay.className = 'highlight-overlay';
            highlightOverlay.style.left = (iframeRect.left + rect.left) + 'px';
            highlightOverlay.style.top = (iframeRect.top + rect.top) + 'px';
            highlightOverlay.style.width = rect.width + 'px';
            highlightOverlay.style.height = rect.height + 'px';
            
            document.body.appendChild(highlightOverlay);
        }
        
        function removeHighlight() {
            if (highlightOverlay) {
                highlightOverlay.remove();
                highlightOverlay = null;
            }
        }
        
        function showElementPreview(selectorKey, element) {
            const previewContainer = document.getElementById(`preview-${selectorKey}`);
            const text = element.textContent.trim().substring(0, 200);
            previewContainer.textContent = text || 'محتوای متنی یافت نشد';
            previewContainer.style.display = 'block';
        }
        
        function editSelector(selectorKey) {
            const currentSelector = selectors[selectorKey].selector;
            const newSelector = prompt(`انتخابگر CSS برای "${selectors[selectorKey].label}":`, currentSelector);
            
            if (newSelector !== null) {
                selectors[selectorKey].selector = newSelector;
                document.getElementById(`selector-${selectorKey}`).textContent = newSelector || 'انتخاب نشده';
            }
        }
        
        function clearSelector(selectorKey) {
            selectors[selectorKey].selector = '';
            selectors[selectorKey].element = null;
            document.getElementById(`selector-${selectorKey}`).textContent = 'انتخاب نشده';
            document.getElementById(`info-${selectorKey}`).textContent = '';
            document.getElementById(`preview-${selectorKey}`).style.display = 'none';
        }
        
        function testSelector(selectorKey) {
            const selector = selectors[selectorKey].selector;
            if (!selector) {
                showToast('انتخابگر تعریف نشده است', 'warning');
                return;
            }
            
            const iframe = document.getElementById('previewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            if (!iframeDoc) {
                showToast('صفحه بارگذاری نشده است', 'warning');
                return;
            }
            
            try {
                const elements = iframeDoc.querySelectorAll(selector);
                if (elements.length > 0) {
                    showToast(`${elements.length} عنصر یافت شد`, 'success');
                    // Highlight found elements briefly
                    elements.forEach((el, index) => {
                        setTimeout(() => {
                            highlightElement(el);
                            setTimeout(removeHighlight, 1000);
                        }, index * 500);
                    });
                } else {
                    showToast('هیچ عنصری یافت نشد', 'warning');
                }
            } catch (error) {
                showToast('انتخابگر نامعتبر است', 'error');
            }
        }
        
        function testSelectors() {
            const iframe = document.getElementById('previewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            if (!iframeDoc) {
                showToast('صفحه بارگذاری نشده است', 'warning');
                return;
            }
            
            const results = {};
            let hasResults = false;
            
            Object.keys(selectors).forEach(key => {
                const selector = selectors[key].selector;
                if (selector) {
                    try {
                        const elements = iframeDoc.querySelectorAll(selector);
                        if (elements.length > 0) {
                            results[key] = {
                                label: selectors[key].label,
                                count: elements.length,
                                sample: elements[0].textContent.trim().substring(0, 100)
                            };
                            hasResults = true;
                        }
                    } catch (error) {
                        results[key] = {
                            label: selectors[key].label,
                            error: 'انتخابگر نامعتبر'
                        };
                    }
                }
            });
            
            if (hasResults) {
                showTestResults(results);
            } else {
                showToast('هیچ نتیجه‌ای یافت نشد', 'warning');
            }
        }
        
        function showTestResults(results) {
            let html = '<div class="test-results"><h6>نتایج تست:</h6>';
            
            Object.keys(results).forEach(key => {
                const result = results[key];
                if (result.error) {
                    html += `<div class="alert alert-danger alert-sm">${result.label}: ${result.error}</div>`;
                } else {
                    html += `<div class="alert alert-success alert-sm">${result.label}: ${result.count} عنصر - ${result.sample}...</div>`;
                }
            });
            
            html += '</div>';
            
            // Show in a modal or toast
            showToast('نتایج تست در کنسول مشاهده کنید', 'info');
            console.log('Test Results:', results);
        }
        
        function addNewSelector() {
            const name = prompt('نام انتخابگر جدید:');
            const label = prompt('برچسب انتخابگر:');
            
            if (name && label) {
                if (selectors[name]) {
                    showToast('انتخابگر با این نام وجود دارد', 'warning');
                    return;
                }
                
                selectors[name] = {
                    label: label,
                    selector: '',
                    element: null
                };
                
                renderSelectors();
                showToast('انتخابگر جدید اضافه شد', 'success');
            }
        }
        
        async function saveConfiguration() {
            const name = document.getElementById('configName').value;
            const description = document.getElementById('configDescription').value;
            const url = document.getElementById('targetUrl').value;
            
            if (!name) {
                showToast('نام پیکربندی الزامی است', 'warning');
                return;
            }
            
            if (!url) {
                showToast('آدرس صفحه الزامی است', 'warning');
                return;
            }
            
            // Filter out empty selectors
            const validSelectors = {};
            Object.keys(selectors).forEach(key => {
                if (selectors[key].selector) {
                    validSelectors[key] = {
                        label: selectors[key].label,
                        selector: selectors[key].selector
                    };
                }
            });
            
            if (Object.keys(validSelectors).length === 0) {
                showToast('حداقل یک انتخابگر باید تعریف شود', 'warning');
                return;
            }
            
            const configData = {
                name: name,
                description: description,
                url: url,
                selectors: validSelectors
            };
            
            try {
                const method = configId ? 'PUT' : 'POST';
                const endpoint = configId ? `/api/selector-builder/configs/${configId}` : '/api/selector-builder/configs';
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(configId ? 'پیکربندی به‌روزرسانی شد' : 'پیکربندی ذخیره شد', 'success');
                    if (!configId) {
                        configId = result.id;
                    }
                } else {
                    throw new Error(result.message || 'خطا در ذخیره پیکربندی');
                }
                
            } catch (error) {
                console.error('Error saving configuration:', error);
                showToast('خطا در ذخیره پیکربندی: ' + error.message, 'error');
            }
        }
        
        async function loadExistingConfig(id) {
            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`/api/selector-builder/configs/${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const config = result.config;
                    configId = id;
                    
                    // Load config data
                    document.getElementById('configName').value = config.name;
                    document.getElementById('configDescription').value = config.description || '';
                    document.getElementById('targetUrl').value = config.url;
                    
                    // Load selectors
                    selectors = {};
                    Object.keys(config.selectors).forEach(key => {
                        selectors[key] = {
                            label: config.selectors[key].label,
                            selector: config.selectors[key].selector,
                            element: null
                        };
                    });
                    
                    renderSelectors();
                    loadPage();
                    
                    showToast('پیکربندی بارگذاری شد', 'success');
                } else {
                    throw new Error(result.message || 'خطا در بارگذاری پیکربندی');
                }
                
            } catch (error) {
                console.error('Error loading configuration:', error);
                showToast('خطا در بارگذاری پیکربندی: ' + error.message, 'error');
            }
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('d-none');
            } else {
                overlay.classList.add('d-none');
            }
        }
        
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>